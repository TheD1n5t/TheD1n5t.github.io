<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mächtiger Donut - LoL Stats</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>LoL Stats per Riot ID</h1>
    <input type="text" id="riotIdInput" placeholder="z. B. Mächtiger Donut#EUW" />
    <button onclick="loadByRiotId()">Riot ID laden</button>

    <div id="summoner-info">
      <p>Bitte Riot ID eingeben.</p>
    </div>

    <div id="match-history">
      <!-- Dynamische Match History wird hier geladen -->
    </div>
  </div>

  <script>
    async function loadByRiotId() {
  const input = document.getElementById("riotIdInput").value;
  const infoDiv = document.getElementById("summoner-info");
  const matchHistoryDiv = document.getElementById("match-history");
  const runesData = await fetch("https://ddragon.leagueoflegends.com/cdn/15.9.1/data/en_US/runesReforged.json").then(r => r.json());
  const spellData = await fetch("https://ddragon.leagueoflegends.com/cdn/15.9.1/data/en_US/summoner.json").then(r => r.json());

  infoDiv.innerHTML = "<p>Lade Daten...</p>";

  const [gameName, tagLine] = input.split("#");
  if (!gameName || !tagLine) {
    infoDiv.innerHTML = "<p style='color: red;'>Bitte eine gültige Riot ID im Format Name#Tag eingeben.</p>";
    return;
  }

  try {
    const proxyUrl = "https://lol-api-proxy.onrender.com";

    // Riot ID abrufen
    const riotRes = await fetch(`${proxyUrl}/riotid/${encodeURIComponent(gameName)}/${encodeURIComponent(tagLine)}`);
    const riotData = await riotRes.json();
    if (!riotData.puuid) throw new Error("Riot ID nicht gefunden.");

    // Summoner-Daten abrufen
    const summRes = await fetch(`${proxyUrl}/summoner/by-puuid/${riotData.puuid}`);
    const summData = await summRes.json();
    const rankedRes = await fetch(`${proxyUrl}/ranked/by-summoner/${summData.id}`);
    const rankedData = await rankedRes.json();
    const soloQ = rankedData.find(entry => entry.queueType === "RANKED_SOLO_5x5");
    const tier = soloQ ? `${soloQ.tier} ${soloQ.rank} – ${soloQ.leaguePoints} LP` : "Unranked";
    const tierUpper = soloQ ? soloQ.tier.toUpperCase() : null;
    const tierUpper = soloQ ? soloQ.tier.toUpperCase() : null;
    const rankIcon = tierUpper ? `<img src="https://opgg-static.akamaized.net/images/medals/${tierUpper}.png" alt="${tierUpper}" style="height: 40px; vertical-align: middle;" />` : '';
    
    infoDiv.innerHTML = `
      <p>
        <strong>${riotData.gameName}#${riotData.tagLine}</strong> (Level ${summData.summonerLevel})<br>
        Rang: ${tier} ${rankIcon}
      </p>`;


    if (!summData.id || !summData.summonerLevel) throw new Error("Summoner-Daten unvollständig.");

    // Match-History (letzte 5 Spiele)
    const matchIdsRes = await fetch(`${proxyUrl}/matches/by-puuid/${riotData.puuid}?count=5`);
    const matchIds = await matchIdsRes.json();

    let matchHistoryHTML = "<h2>Letzte Spiele:</h2>";
    function findRuneIcon(perkId) {
      for (const style of runesData) {
        for (const slot of style.slots) {
          for (const rune of slot.runes) {
            if (rune.id === perkId) return rune.icon;
          }
        }
      }
      return null;
    }

    function findSummonerSpell(spellId) {
      for (const key in spellData.data) {
        const spell = spellData.data[key];
        if (parseInt(spell.key) === spellId) {
          return {
            name: spell.name,
            icon: `https://ddragon.leagueoflegends.com/cdn/15.9.1/img/spell/${spell.image.full}`
          };
        }
      }
      return null;
    }


    function findStyleIcon(styleId) {
      const style = runesData.find(s => s.id === styleId);
      return style ? style.icon : null;
    }

    for (const matchId of matchIds) {
      const matchRes = await fetch(`${proxyUrl}/match/${matchId}`);
      const matchData = await matchRes.json();
      const player = matchData.info.participants.find(p => p.puuid === riotData.puuid);

      if (player) {
        // Runes
        const primaryRune = player.perks.styles[0]?.selections[0]?.perk;
        const secondaryRuneStyle = player.perks.styles[1]?.style;
        
        const primaryRuneIcon = findRuneIcon(primaryRune);
        const secondaryRuneIcon = findStyleIcon(secondaryRuneStyle);

        const summ1 = findSummonerSpell(player.summoner1Id);
        const summ2 = findSummonerSpell(player.summoner2Id);
        
        const runeImg = (icon) =>
          icon ? `<img class="rune" src="https://ddragon.leagueoflegends.com/cdn/img/${icon}" />` : '';


        const result = player.win ? "<span style='color:lightgreen;'>Sieg</span>" : "<span style='color:orangered;'>Niederlage</span>";
        const championIcon = `https://ddragon.leagueoflegends.com/cdn/15.9.1/img/champion/${player.championName}.png`;

        // Sicherstellen, dass player.items definiert ist und nicht leer ist
        const itemIds = [];
        for (let i = 0; i <= 6; i++) {
          const itemId = player[`item${i}`];
          if (itemId && itemId !== 0) {
            itemIds.push(itemId);
          }
        }
        // Debugging-Ausgabe für Items
        if (itemIds.length === 0) {
          console.log("Keine Items verfügbar für Spieler", player.championName);
        }

        // Dynamisch Item-Bilder rendern, falls vorhanden
        const itemElements = itemIds.length > 0 
          ? itemIds.map(itemId => 
              `<img src="https://ddragon.leagueoflegends.com/cdn/15.9.1/img/item/${itemId}.png" />`).join('')
          : "<p>Keine Items verfügbar.</p>";

        matchHistoryHTML += `
          <div class="match-card ${player.win ? 'win' : 'loss'}">
            <div class="match-mode">
              <div class="mode">${matchData.info.queueId === 420 ? 'Ranked' : 'Normal'}</div>
              <div class="time">${new Date(matchData.info.gameCreation).toLocaleString()}</div>
              <div class="duration">${Math.floor(matchData.info.gameDuration / 60)} Min</div>
            </div>

            <div class="champion-block">
              <div class="champion">
                <img class="champ-icon" src="${championIcon}" alt="${player.championName}" />
                <div class="level">${player.champLevel}</div>
              </div>
              <div class="spells-runes">
                <img class="spell" src="${summ1?.icon}" title="${summ1?.name}" />
                <img class="spell" src="${summ2?.icon}" title="${summ2?.name}" />
                ${runeImg(primaryRuneIcon)}${runeImg(secondaryRuneIcon)}
              </div>
            </div>

            <div class="stats">
              <div class="kda">${player.kills} / ${player.deaths} / ${player.assists}</div>
              <div class="kda-ratio">${Math.round((player.kills + player.assists) / player.deaths)}:1 KDA</div>
            </div>

            <div class="items">
              ${itemElements}
            </div>
          </div>
        `;
      }
    }

    matchHistoryDiv.innerHTML = matchHistoryHTML;
  } catch (err) {
    infoDiv.innerHTML = infoDiv.innerHTML = `<p style="color:red;">Fehler beim Laden der Daten: ${err.message}</p>`;
    console.error("Fehler beim Laden:", err);
  }
}


  </script>
</body>
</html>
