<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mächtiger Donut - LoL Stats</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>LoL Stats per Riot ID</h1>
    <input type="text" id="riotIdInput" placeholder="z. B. Mächtiger Donut#EUW" />
    <button id="loadButton">Riot ID laden</button>

    <div id="summoner-info">
      <p>Bitte Riot ID eingeben.</p>
    </div>

    <div id="match-history">
      <!-- Dynamische Match History wird hier geladen -->
    </div>
  </div>

  <script>
    document.getElementById("loadButton").addEventListener("click", loadByRiotId);

    async function loadByRiotId() {
      const input = document.getElementById("riotIdInput").value;
      const infoDiv = document.getElementById("summoner-info");
      const matchHistoryDiv = document.getElementById("match-history");
      infoDiv.innerHTML = "<p>Lade Daten...</p>";

      const [gameName, tagLine] = input.split("#");
      if (!gameName || !tagLine) {
        infoDiv.innerHTML = "<p style='color: red;'>Bitte eine gültige Riot ID im Format Name#Tag eingeben.</p>";
        return;
      }

      try {
        const proxyUrl = "https://lol-api-proxy.onrender.com";

        const runesData = await fetch("https://ddragon.leagueoflegends.com/cdn/15.9.1/data/en_US/runesReforged.json").then(r => r.json());
        const spellData = await fetch("https://ddragon.leagueoflegends.com/cdn/15.9.1/data/en_US/summoner.json").then(r => r.json());

        const riotRes = await fetch(`${proxyUrl}/riotid/${encodeURIComponent(gameName)}/${encodeURIComponent(tagLine)}`);
        const riotData = await riotRes.json();
        if (!riotData.puuid) throw new Error("Riot ID nicht gefunden.");

        const summRes = await fetch(`${proxyUrl}/summoner/by-puuid/${riotData.puuid}`);
        const summData = await summRes.json();
        const rankedRes = await fetch(`${proxyUrl}/ranked/by-summoner/${summData.id}`);
        const rankedData = await rankedRes.json();
        const soloQ = rankedData.find(entry => entry.queueType === "RANKED_SOLO_5x5");
        const tier = soloQ ? `${soloQ.tier} ${soloQ.rank} – ${soloQ.leaguePoints} LP` : "Unranked";

        infoDiv.innerHTML = `<p><strong>${riotData.gameName}#${riotData.tagLine}</strong> (Level ${summData.summonerLevel})<br>Rang: ${tier}</p>`;

        const matchIdsRes = await fetch(`${proxyUrl}/matches/by-puuid/${riotData.puuid}?count=5`);
        const matchIds = await matchIdsRes.json();

        let matchHistoryHTML = "<h2>Letzte Spiele:</h2>";

        for (const matchId of matchIds) {
          const matchRes = await fetch(`${proxyUrl}/match/${matchId}`);
          const matchData = await matchRes.json();
          const player = matchData.info.participants.find(p => p.puuid === riotData.puuid);
          const allPlayers = matchData.info.participants;
          const teamBlue = allPlayers.filter(p => p.teamId === 100);
          const teamRed = allPlayers.filter(p => p.teamId === 200);

          function summarizeStat(players, key) {
            return players.reduce((sum, p) => sum + (p[key] || 0), 0);
          }

          const killsBlue = summarizeStat(teamBlue, "kills");
          const killsRed = summarizeStat(teamRed, "kills");
          const goldBlue = summarizeStat(teamBlue, "goldEarned");
          const goldRed = summarizeStat(teamRed, "goldEarned");
          const csBlue = teamBlue.reduce((sum, p) => sum + (p.totalMinionsKilled + p.neutralMinionsKilled), 0);
          const csRed = teamRed.reduce((sum, p) => sum + (p.totalMinionsKilled + p.neutralMinionsKilled), 0);
          const dmgBlue = summarizeStat(teamBlue, "totalDamageDealtToChampions");
          const dmgRed = summarizeStat(teamRed, "totalDamageDealtToChampions");
          const dmgTakenBlue = summarizeStat(teamBlue, "totalDamageTaken");
          const dmgTakenRed = summarizeStat(teamRed, "totalDamageTaken");
          const visionBlue = summarizeStat(teamBlue, "visionScore");
          const visionRed = summarizeStat(teamRed, "visionScore");

          const teamAnalysisHTML = `
            <div class="team-analysis-wrapper">
              <button class="toggle-analysis">Team-Analyse anzeigen ▼</button>
              <div class="team-analysis" style="display:none">
                <h4>Team-Analyse</h4>
                <table>
                  <tr><th>Stat</th><th style="color:#38f;">Blau</th><th style="color:#f44;">Rot</th></tr>
                  <tr><td>Kills</td><td>${killsBlue}</td><td>${killsRed}</td></tr>
                  <tr><td>Gold</td><td>${goldBlue}</td><td>${goldRed}</td></tr>
                  <tr><td>Schaden</td><td>${dmgBlue}</td><td>${dmgRed}</td></tr>
                  <tr><td>Erlittener Schaden</td><td>${dmgTakenBlue}</td><td>${dmgTakenRed}</td></tr>
                  <tr><td>CS</td><td>${csBlue}</td><td>${csRed}</td></tr>
                  <tr><td>Wardscore</td><td>${visionBlue}</td><td>${visionRed}</td></tr>
                </table>
              </div>
            </div>
          `;

          const championIcon = `https://ddragon.leagueoflegends.com/cdn/15.9.1/img/champion/${player.championName}.png`;
          const matchMainHTML = `
            <div class="match-main">
              <img class="champ-icon" src="${championIcon}" alt="${player.championName}" />
              <div class="kda">${player.kills} / ${player.deaths} / ${player.assists}</div>
              <div class="result">${player.win ? 'Sieg' : 'Niederlage'}</div>
            </div>
          `;

          matchHistoryHTML += `
            <div class="match-block">
              ${matchMainHTML}
              ${teamAnalysisHTML}
            </div>
          `;
        }

        matchHistoryDiv.innerHTML = matchHistoryHTML;

        document.querySelectorAll('.toggle-analysis').forEach(button => {
          button.addEventListener('click', () => {
            const panel = button.nextElementSibling;
            const visible = panel.style.display === 'block';
            panel.style.display = visible ? 'none' : 'block';
            button.innerHTML = visible ? 'Team-Analyse anzeigen ▼' : 'Team-Analyse verbergen ▲';
          });
        });
      } catch (err) {
        infoDiv.innerHTML = `<p style="color:red;">Fehler beim Laden der Daten: ${err.message}</p>`;
        console.error("Fehler beim Laden:", err);
      }
    }
  </script>
</body>
</html>
